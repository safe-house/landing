{% extends "./dashboard_base.html" %}
{% load tags %}

{% block main-content %}


    <div class="page-header row no-gutters py-4">
        <div class="col-12 col-sm-4 text-center text-sm-left mb-0">
            <span class="text-uppercase page-subtitle">Dashboard</span>
        </div>
    </div>
    <!-- End Page Header -->
    <div>
        {% for valve in valves_list %}
            <div class="row" style="padding-left: 50px">
                {% csrf_token %}
                <div class="card" name="valve" style="width: 180px; margin: 20px;">
                    <p id="{{ valve.id }}">

                        <br>
                        Name: <a class="name">{{ valve.name }}</a>
                        <br>
                        Location: <a class="location">{{ locations_list|get_value:valve.location }}</a>
                        <br>


                        Type: <a class="type">{% if valve.type %} Gas {% else %} Water {% endif %}</a>
                        <br>
                        <a class="closed">{% if valve.closed %} Closed {% else %} Open {% endif %} </a>
                        <br>
                        Last Update: <a class="last_update">{{ valve.last_updated|date:"d M H\:i:s" }}</a>
                    </p>
                    {#                            <form class="" action="{% url 'close_valve' %}" method="post">#}
                    {% csrf_token %}
                    {#                            <button type="button" onclick="close_valve()">Close Valve</button>#}
                    {#                            </form>#}

                </div>

                {% for sensor in sensors_list %}
                    {% if sensor.valve == valve.id %}
                        <div class="card" name="sensor" style="width: 160px; margin: 20px;">
                            <p id="{{ valve.id }}">

                                <br>
                                Name: <a class="name"> {{ sensor.name }}</a>
                                <br>
                                Location: <a
                                    class="location">{{ locations_list|get_value:sensor.location }}</a>
                                <br>

                            </p>
                        </div>
                    {% endif %}
                {% endfor %}

            </div>
        {% endfor %}
    </div>

    </div>
{#    <footer class="main-footer d-flex p-2 px-3 bg-white border-top">#}
{#        <ul class="nav">#}
{#            <li class="nav-item">#}
{#                <a class="nav-link" href="#">Home</a>#}
{#            </li>#}
{#            <li class="nav-item">#}
{#                <a class="nav-link" href="#">Services</a>#}
{#            </li>#}
{#            <li class="nav-item">#}
{#                <a class="nav-link" href="#">About</a>#}
{#            </li>#}
{#            <li class="nav-item">#}
{#                <a class="nav-link" href="#">Products</a>#}
{#            </li>#}
{#            <li class="nav-item">#}
{#                <a class="nav-link" href="#">Blog</a>#}
{#            </li>#}
{#        </ul>#}
{#        <span class="copyright ml-auto my-auto mr-2">Copyright Â© 2018#}
{#              <a href="https://designrevision.com" rel="nofollow">DesignRevision</a>#}
{#            </span>#}
{#    </footer>#}
    </main>
    </div>
    </div>


{% endblock %}
{% block script %}
    <script type="text/javascript">
        const csrf_token = jQuery("[name=csrfmiddlewaretoken]").val();
        window.setInterval(function () {
            console.log("test")
            $.ajax({
                headers: {'X-CSRFToken': csrf_token},
                type: 'POST',
                async: true,
                url: '{% url 'update_sensors_and_valves' %}',
                success: function (data) {
                    const valves = data["valves"];
                    if(valves) {
                    for (var i = 1; i < valves.length + 1; i++) {
                        var valve_state = $("#" + i).children('a[class$="closed"]')
                        if (valves[i - 1][1] === 1) {

                            valve_state.text("Closed")
                        } else {
                            valve_state.text("Open")
                        }
                        var months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun",
                            "Jul", "Aug", "Sep", "Oct", "Now", "Dec"];
                        var date = valves[i - 1][2];
                        if (date) {
                            var month = date.substring(5, 7);
                            if (month[0] == "0") {
                                month = month[1];
                            }
                            var day = date.substring(8, 10);
                            var time = date.substring(11);
                            $("#" + i).children('a[class$="last_update"]').text(day + " " + months[month - 1] + " " + time);
                        }
                    }
                }},
                dataType: 'json',
            });
        }, 3000);
    </script>
{% endblock %}