{% extends "./base.html" %}
{% load tags %}
{% block body %}
    <div>
    {% for valve in valves_list %}
        <div class="row" style="padding-left: 50px">
        {% csrf_token %}
            <div class="card" name="valve" style="width: 180px; margin: 20px;">
                <p id="{{ valve.id }}">

                    <br>
                    Name: <a class="name">{{ valve.name }}</a>
                    <br>
                    Location: <a class="location">{{ locations_list|get_value:valve.location }}</a>
                    <br>


                    Type: <a class="type">{% if valve.type %} Gas {% else %} Water {% endif %}</a>
                    <br>
                    <a class="closed">{% if valve.closed %} Closed {% else %} Open {% endif %} </a>
                    <br>
                    Last Update: <a class="last_update">{{ valve.last_updated|date:"d M H\:i:s" }}</a>
                </p>

            </div>

            {% for sensor in sensors_list %}
                {% if sensor.valve == valve.id %}
                    <div class="card" name="sensor" style="width: 160px; margin: 20px;">
                        <p id="{{ valve.id }}">

                            <br>
                            Name: <a class="name"> {{ sensor.name }}</a>
                            <br>
                            Location: <a class="location">{{ locations_list|get_value:sensor.location }}</a>
                            <br>

                        </p>
                    </div>
                {% endif %}
            {% endfor %}

        </div>
    {% endfor %}
    </div>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script type="text/javascript">
        const csrf_token = jQuery("[name=csrfmiddlewaretoken]").val();
        console.log("script")
        window.setInterval(function () {
            console.log("test")
            $.ajax({
                headers: {'X-CSRFToken': csrf_token},
                type: 'POST',
                async: true,
                url: '{% url 'update_sensors_and_valves' %}',
                success: function (data) {
                    const valves = data["valves"];
                    for (var i = 1; i < valves.length + 1; i++) {
                        var valve_state = $("#" + i).children('a[class$="closed"]')
                        if (valves[i - 1][1] === 1) {

                            valve_state.text("Closed")
                        } else {
                            valve_state.text("Open")
                        }
                        var months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun",
                            "Jul", "Aug", "Sep", "Oct", "Now", "Dec"];
                        var date = valves[i - 1][2];
                        if (date) {
                            var month = date.substring(5, 7);
                            if (month[0] == "0") {
                                month = month[1];
                            }
                            var day = date.substring(8, 10);
                            var time = date.substring(11);
                            $("#" + i).children('a[class$="last_update"]').text(day + " " + months[month] + " " + time);
                        }
                    }
                },
                dataType: 'json',
            });
        }, 3000);
    </script>
{% endblock %}
